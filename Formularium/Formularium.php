<?php declare(strict_types=1);

namespace Formularium;

use Formularium\Exception\Exception;
use HaydenPierce\ClassFinder\ClassFinder;

/**
 * Abstract base class for frameworks. Each framework should have a class inheriting
 * from this class.
 */
final class Formularium
{
    /**
     *
     * @var string[]
     */
    private static $validatorNamespaces = [
        'Formularium\\Validator'
    ];

    /**
     *
     * @var string[]
     */
    private static $datatypeNamespaces = [
        'Formularium\\Datatype'
    ];

    /**
     * @codeCoverageIgnore
     */
    private function __construct()
    {
        // empty
    }

    public static function appendDatatypeNamespace(string $ns): void
    {
        self::$datatypeNamespaces[] = $ns;
    }

    public static function appendValidatorNamespace(string $dir): void
    {
        self::$validatorNamespaces[] = $dir;
    }

    /**
     * Returns a list class name => datatype.
     *
     * @return array<string, string>
     */
    public static function getDatatypeNames(): array
    {
        $datatypes = [];

        foreach (self::$datatypeNamespaces as $datatypeNamespace) {
            /** @var string[] $classesInNamespace */
            $classesInNamespace = ClassFinder::getClassesInNamespace($datatypeNamespace);

            foreach ($classesInNamespace as $class) {
                $reflection = new \ReflectionClass($class);
                if (!$reflection->isInstantiable()) {
                    continue;
                }

                if (!is_a($class, Datatype::class, true)) {
                    continue;
                }

                /**
                 * @var Datatype $d
                 */
                $d = new $class();

                $datatypes[$class] = $d->getName();
            }
        }

        return $datatypes;
    }

    /**
     * Returns a list classname => validator
     *
     * @return array<string, string>
     */
    public static function getValidatorNames(): array
    {
        $validators = [];

        foreach (self::$validatorNamespaces as $validatorNamespace) {
            /** @var string[] $classesInNamespace */
            $classesInNamespace = ClassFinder::getClassesInNamespace($validatorNamespace);

            foreach ($classesInNamespace as $class) {
                $reflection = new \ReflectionClass($class);
                if (!$reflection->isInstantiable()) {
                    continue;
                }

                if (!is_a($class, ValidatorInterface::class, true)) {
                    continue;
                }

                $name = mb_substr($class, strrpos($class, '\\') + 1);
                $validators[$class] = $name;
            }
        }

        return $validators;
    }

    /**
     * Returns a list of datatype class names
     *
     * @return array
     */
    public static function getValidatorNamesOld(): array
    {
        $validators = [];
        foreach (self::$validatorDirectories as $dir) {
            $files = scandir($dir);
            if (!$files) {
                throw new Exception('Validators not found');
            }
            $v = array_map(
                function ($x) {
                    return str_replace('.php', '', $x);
                },
                array_diff($files, array('.', '..'))
            );
            $validators = array_merge($validators, $v);
        }
        return $validators;
    }

    public static function scalarGraphqlDirectives(): string
    {
        $classes = static::getDatatypeNames();
        $graphql = [];
        foreach ($classes as $className => $name) {
            $graphql[] = "scalar $name @scalar(class: \"{$className}\")";
        }

        return '
# File generated by Formularium.
# Do not edit this file directly.

' . join("\n\n", $graphql);
    }

    public static function validatorGraphqlDirectives(): string
    {
        $classes = static::getValidatorNames();
        $graphql = [];
        foreach ($classes as $className => $name) {
            $graphql[] = $className::getMetadata()->toGraphql();
        }

        return '
# File generated by Formularium.
# Do not edit this file directly.

' . join("\n", $graphql);
    }
}
